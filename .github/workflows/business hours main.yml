name: Calculate Business Hours & SLA Breach

on:
  issues:
    types: [closed]

permissions:
  contents: write
  issues: write

jobs:
  calculate-business-hours:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get Issue ID and Metadata
        id: get_issue_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}  # Corrected: Use issue number instead of node ID
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> "$GITHUB_ENV"


      - name: Run Business Hours Calculation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/calculate_hours.py "$ISSUE_ID" "$GITHUB_REPOSITORY_OWNER" "$GITHUB_REPOSITORY_NAME" "$GH_TOKEN" > business_hours_output.txt

      - name: Extract Business Hours Values
        run: |
          TOTAL_HOURS=$(grep 'Total Business Hours:' business_hours_output.txt | cut -d ':' -f2 | tr -d ' ')
          SLA_BREACHED=$(grep 'SLA Breached:' business_hours_output.txt | cut -d ':' -f2- | sed 's/^ //')
          echo "TOTAL_HOURS=$TOTAL_HOURS" >> "$GITHUB_ENV"
          echo "SLA_BREACHED=$SLA_BREACHED" >> "$GITHUB_ENV"

      - name: Update Project Fields
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROJECT_ID="PVT_kwHOBffn_c4Ay8TW"
          TOTAL_HOURS_FIELD_ID="PVTF_lAHOBffn_c4Ay8TWzgo5RLc"
          SLA_BREACHED_FIELD_ID="PVTF_lAHOBffn_c4Ay8TWzgo5RYQ"
          PROJECT_ITEM_ID=$(gh api graphql -H "Authorization: Bearer $GH_TOKEN" -f query='{ node(id: "'$PROJECT_ID'") { ... on ProjectV2 { items(first: 100) { nodes { id content { ... on Issue { id } } } } } } }' --jq '.data.node.items.nodes[] | select(.content.id=="'$ISSUE_ID'") | .id')
          if [ -z "$PROJECT_ITEM_ID" ]; then exit 1; fi
          gh api graphql -H "Authorization: Bearer $GH_TOKEN" -f query='mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: Float!) { updateProjectV2ItemFieldValue(input: { projectId: $projectId itemId: $itemId fieldId: $fieldId value: { number: $value } }) { projectV2Item { id } } }' -F projectId="$PROJECT_ID" -F itemId="$PROJECT_ITEM_ID" -F fieldId="$TOTAL_HOURS_FIELD_ID" -F value="$TOTAL_HOURS"
          gh api graphql -H "Authorization: Bearer $GH_TOKEN" -f query='mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) { updateProjectV2ItemFieldValue(input: { projectId: $projectId itemId: $itemId fieldId: $fieldId value: { text: $value } }) { projectV2Item { id } } }' -F projectId="$PROJECT_ID" -F itemId="$PROJECT_ITEM_ID" -F fieldId="$SLA_BREACHED_FIELD_ID" -F value="$SLA_BREACHED"
